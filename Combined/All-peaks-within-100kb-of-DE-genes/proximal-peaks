#!/bin/sh -e

##########################################################################
#   Filter locations of genes from GTF
#   Ensembl GTF has many more gene IDs represented than CDNA.
#   CDNA reference contains a few genes not in the GTF.
#   all-but-xy.transcripts.clean.fa is generated from either GTF or CDNA
##########################################################################

ref_dir="../../RNA-Seq/Reference"
release=$($ref_dir/reference-release)
gtf="$ref_dir/Mus_musculus.GRCm38.$release.gtf"

# This ref was generated from CDNA in the last kallisto run
# reference="$ref_dir/all-but-xy.transcripts.clean.fa"

gene_locations=gene-locations-$release.tsv
#if [ ! -e $gene_locations ]; then
    printf "Generating $gene_locations...\n"
    # Chr feature-type start stop gene-ID
    awk '$3 == "gene" && $9 == "gene_id" {
	gsub("\"", "", $10);
	gsub(";", "", $10);
	printf("%s\t%s\t%s\t%s\t%s\n", $1, $3, $4, $5, $10);
    }' $gtf | sort -k 5 > $gene_locations
#fi
wc -l $gene_locations
head -5 $gene_locations

##########################################################################
#   Get gene IDs from RNA-Seq clustering results
##########################################################################

for cell_type in chondro neuro; do
    
    # Col 16 of augmented Sleuth output contains cluster # for each gene
    # List of unique values in this column enumerates clusters
    tsv="../../RNA-Seq/Clusters/$cell_type.tsv"
    clusters=$(awk '$1 != "target_id" { print $16 }' $tsv | sort | uniq)
    
    for cluster in $clusters; do
	cluster_gene_list=gene-list-$cell_type-cluster-$cluster.txt
	# printf "$cell_type cluster $cluster...\n"
	awk "\$16 == $cluster { print \$2 }" $tsv | sort | uniq \
	    > $cluster_gene_list
	wc -l $cluster_gene_list
	head -n 2 $cluster_gene_list
	
	# Generate BED file of genes and locations
	cluster_gene_locations=${cluster_gene_list%.txt}.bed
	awk -v gene_locations=$gene_locations -f lookup-gene-locations.awk \
	    $cluster_gene_list > $cluster_gene_locations
	cluster_gene_lists="$cluster_gene_lists $cluster_gene_list"
    done
done

exit

##########################################################################
#   Find all peaks (both differential and stable accessibility) within
#   100kb of DE gene TSS by cluster
##########################################################################


